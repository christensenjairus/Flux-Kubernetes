apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-crds
  namespace: flux-system
spec:
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/crds
  prune: true
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-lb-stage-1
  namespace: flux-system
spec:
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/lb/stage-1
  prune: true
  patches:
    - patch: |
        - op: add
          path: /spec/template/spec/containers/0/args/-
          value: "--ignore-exclude-lb"
      target:
        kind: DaemonSet
        name: speaker
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-lb-stage-2
  namespace: flux-system
spec:
  dependsOn:
    - name: infra-lb-stage-1
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/lb/stage-2
  prune: true
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-networking
  namespace: flux-system
spec:
  dependsOn:
    #- name: infra-lb-stage-2     # I forget why this was needed
    - name: infra-ingress # needed for ingresses to pass a validating webhook
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/networking
  prune: true
  patches:
    - patch: |
        - op: replace
          path: /spec/values/clustermesh/apiserver/replicas
          value: 1
        - op: replace
          path: /spec/values/operator/replicas
          value: 1
      target:
        kind: HelmRelease
        name: cilium
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-monitoring
  namespace: flux-system
spec:
  dependsOn:
    #- name: infra-networking # I forget why this was needed
    - name: infra-ingress    # needed for ingress validating webhook, also ingress waits for infra-storage which is also needed for a pvc
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/monitoring
  prune: true
  patches:
    - patch: |
        - op: replace
          path: /spec/replicas
          value: 1
      target:
        kind: Deployment
        name: metrics-server
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-certs-stage-1
  namespace: flux-system
spec:
  dependsOn:
    - name: infra-ingress # Needed for validating webhook
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/certs
  prune: true
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-certs-stage-2
  namespace: flux-system
spec:
  dependsOn:
    - name: infra-certs-stage-1
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/certs
  prune: false # don't delete my storage
  patches:
    - patch: | # use staging letsencrypt server
        - op: replace
          path: /spec/acme/server
          value: https://acme-staging-v02.api.letsencrypt.org/directory
      target:
        kind: ClusterIssuer
        name: letsencrypt
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-ingress
  namespace: flux-system
spec:
  dependsOn:
    #- name: infra-lb  # I forget why this was needed
    - name: infra-storage-stage-2 # needed for cache pvc
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/ingress/overlays
  prune: false # don't delete my storage
  patches:
    # don't autoscale and remove resource requirements
    - patch: |
        - op: add
          path: /spec/values/controller/autoscaling/enabled
          value: false
        - op: add
          path: /spec/values/controller/resources
          value: {}
        - op: add
          path: /spec/values/controller/replicaCount
          value: 1
        - op: add
          path: /spec/values/defaultBackend/replicaCount
          value: 1
      target:
        kind: HelmRelease
        name: ingress-nginx
        namespace: ingress-nginx.*
    # reduce the severity of NGINXTooMany400s alert
    - patch: |
        - op: replace
          path: /spec/groups/0/rules/0/labels/severity
          value: "none"
      target:
        kind: PrometheusRule
        name: prometheus-ingress-rules
        namespace: ingress-nginx.*
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-policies-stage-1
  namespace: flux-system
spec:
  interval: 1h
  retryInterval: 1m
  timeout: 5m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/policies/stage-1
  prune: true
  wait: true
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-policies-stage-2
  namespace: flux-system
spec:
  dependsOn:
    - name: infra-policies-stage-1
  interval: 1h
  retryInterval: 1m
  timeout: 5m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/policies/stage-2/overlays/harbor-registry-all-pods
  prune: true
  wait: true
#---
#apiVersion: kustomize.toolkit.fluxcd.io/v1
#kind: Kustomization
#metadata:
#  name: infra-scaling
#  namespace: flux-system
#spec:
#  dependsOn:
#    - name: infra-crds
#  interval: 1h
#  retryInterval: 1m
#  timeout: 5m
#  sourceRef:
#    kind: GitRepository
#    name: flux-system
#  path: ./infrastructure/base/scaling
#  prune: true
#  wait: true
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-storage-stage-1
  namespace: flux-system
spec:
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/storage/stage-1
  prune: true
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-storage-stage-2
  namespace: flux-system
spec:
  dependsOn:
    - name: infra-storage-stage-1
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/storage/stage-2
  prune: true
---
#apiVersion: kustomize.toolkit.fluxcd.io/v1
#kind: Kustomization
#metadata:
#  name: infra-backups
#  namespace: flux-system
#spec:
#  dependsOn:
#    - name: infra-crds
#  interval: 1h
#  retryInterval: 1m
#  timeout: 5m
#  sourceRef:
#    kind: GitRepository
#    name: flux-system
#  path: ./infrastructure/base/backups
#  prune: true
#  wait: true
#---
#apiVersion: kustomize.toolkit.fluxcd.io/v1
#kind: Kustomization
#metadata:
#  name: infra-general-operators
#  namespace: flux-system
#spec:
#  dependsOn:
#    - name: infra-crds
#  interval: 1h
#  retryInterval: 1m
#  timeout: 5m
#  sourceRef:
#    kind: GitRepository
#    name: flux-system
#  path: ./infrastructure/base/general-operators
#  prune: true
#  wait: true