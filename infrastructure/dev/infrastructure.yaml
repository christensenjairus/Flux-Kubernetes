apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-crds
  namespace: flux-system
spec:
  interval: 1h
  retryInterval: 1m
  timeout: 10m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/crds
  prune: true
  wait: true
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-arp
  namespace: flux-system
spec:
  interval: 1h
  retryInterval: 1m
  timeout: 10m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/arp
  prune: true
  wait: true
  patches:
    - patch: |
        - op: add
          path: /spec/template/spec/containers/0/args/-
          value: "--ignore-exclude-lb"
      target:
        kind: DaemonSet
        name: speaker
  postBuild:
    substituteFrom:
      - kind: ConfigMap
        name: cluster-vars
#---
#apiVersion: kustomize.toolkit.fluxcd.io/v1
#kind: Kustomization
#metadata:
#  name: infra-networking
#  namespace: flux-system
#spec:
#  dependsOn:
#    - name: infra-crds
#    - name: infra-arp
#    - name: infra-ingress
#  interval: 1h
#  retryInterval: 1m
#  timeout: 5m
#  sourceRef:
#    kind: GitRepository
#    name: flux-system
#  path: ./infrastructure/base/networking
#  prune: true
#  wait: true
#  patches:
#    - patch: |
#        - op: replace
#          path: /spec/values/clustermesh/apiserver/replicas
#          value: 1
#        - op: replace
#          path: /spec/values/operator/replicas
#          value: 1
#      target:
#        kind: HelmRelease
#        name: cilium
#---
#apiVersion: kustomize.toolkit.fluxcd.io/v1
#kind: Kustomization
#metadata:
#  name: infra-monitoring
#  namespace: flux-system
#spec:
#  dependsOn:
#    - name: infra-crds
#    - name: infra-networking
#    - name: infra-ceph
#  interval: 1h
#  retryInterval: 1m
#  timeout: 5m
#  sourceRef:
#    kind: GitRepository
#    name: flux-system
#  path: ./infrastructure/base/monitoring
#  prune: true
#  wait: true
#  patches:
#    - patch: |
#        - op: replace
#          path: /spec/replicas
#          value: 1
#      target:
#        kind: Deployment
#        name: metrics-server
#---
#apiVersion: kustomize.toolkit.fluxcd.io/v1
#kind: Kustomization
#metadata:
#  name: infra-certificates
#  namespace: flux-system
#spec:
#  dependsOn:
#    - name: infra-crds
#    - name: infra-networking
#  interval: 1h
#  retryInterval: 1m
#  timeout: 5m
#  sourceRef:
#    kind: GitRepository
#    name: flux-system
#  path: ./infrastructure/base/certificates
#  prune: true
#  wait: true
#  patches:
#    - patch: | # use staging letsencrypt server
#        - op: replace
#          path: /spec/acme/server
#          value: https://acme-staging-v02.api.letsencrypt.org/directory
#      target:
#        kind: ClusterIssuer
#        name: letsencrypt
#---
#apiVersion: kustomize.toolkit.fluxcd.io/v1
#kind: Kustomization
#metadata:
#  name: infra-ingress
#  namespace: flux-system
#spec:
#  dependsOn:
#    - name: infra-crds
#    - name: infra-arp
#    - name: infra-ceph
#  interval: 1h
#  retryInterval: 1m
#  timeout: 5m
#  sourceRef:
#    kind: GitRepository
#    name: flux-system
#  path: ./infrastructure/base/ingress/overlays
#  prune: true
#  wait: true
#  patches:
#    - patch: |
#        - op: replace
#          path: /spec/values/controller/autoscaling/enabled
#          value: false
#        - op: replace
#          path: /spec/values/controller/replicaCount
#          value: 1
#        - op: replace
#          path: /spec/values/defaultBackend/replicaCount
#          value: 1
#      target:
#        kind: HelmRelease
#        name: ingress-nginx
#        namespace: ingress-nginx-public
#    - patch: |
#        - op: replace
#          path: /spec/values/controller/autoscaling/enabled
#          value: false
#        - op: replace
#          path: /spec/values/controller/replicaCount
#          value: 1
#        - op: replace
#          path: /spec/values/defaultBackend/replicaCount
#          value: 1
#      target:
#        kind: HelmRelease
#        name: ingress-nginx
#        namespace: ingress-nginx-private
#    # reduce the severity of NGINXTooMany400s alert
#    - patch: |
#        - op: replace
#          path: /spec/groups/0/rules/0/labels/severity
#          value: "none"
#      target:
#        kind: PrometheusRule
#        name: prometheus-ingress-rules-private
#    - patch: |
#        - op: replace
#          path: /spec/groups/0/rules/0/labels/severity
#          value: "none"
#      target:
#        kind: PrometheusRule
#        name: prometheus-ingress-rules-public
#---
#apiVersion: kustomize.toolkit.fluxcd.io/v1
#kind: Kustomization
#metadata:
#  name: infra-kyverno
#  namespace: flux-system
#spec:
#  dependsOn:
#    - name: infra-crds
#  interval: 1h
#  retryInterval: 1m
#  timeout: 5m
#  sourceRef:
#    kind: GitRepository
#    name: flux-system
#  path: ./infrastructure/base/kyverno
#  prune: true
#  wait: true
#---
#apiVersion: kustomize.toolkit.fluxcd.io/v1
#kind: Kustomization
#metadata:
#  name: infra-policies
#  namespace: flux-system
#spec:
#  dependsOn:
#    - name: infra-crds
#    - name: infra-kyverno
#  interval: 1h
#  retryInterval: 1m
#  timeout: 5m
#  sourceRef:
#    kind: GitRepository
#    name: flux-system
#  path: ./infrastructure/base/policies/overlays/harbor-registry-all-pods
#  prune: true
#  wait: true
#---
#apiVersion: kustomize.toolkit.fluxcd.io/v1
#kind: Kustomization
#metadata:
#  name: infra-scaling
#  namespace: flux-system
#spec:
#  dependsOn:
#    - name: infra-crds
#  interval: 1h
#  retryInterval: 1m
#  timeout: 5m
#  sourceRef:
#    kind: GitRepository
#    name: flux-system
#  path: ./infrastructure/base/scaling
#  prune: true
#  wait: true
#---
#apiVersion: kustomize.toolkit.fluxcd.io/v1
#kind: Kustomization
#metadata:
#  name: infra-ceph
#  namespace: flux-system
#spec:
#  dependsOn:
#    - name: infra-crds
#  interval: 1h
#  retryInterval: 1m
#  timeout: 5m
#  sourceRef:
#    kind: GitRepository
#    name: flux-system
#  path: ./infrastructure/base/ceph
#  prune: true
#  wait: true
#---
#apiVersion: kustomize.toolkit.fluxcd.io/v1
#kind: Kustomization
#metadata:
#  name: infra-backups
#  namespace: flux-system
#spec:
#  dependsOn:
#    - name: infra-crds
#  interval: 1h
#  retryInterval: 1m
#  timeout: 5m
#  sourceRef:
#    kind: GitRepository
#    name: flux-system
#  path: ./infrastructure/base/backups
#  prune: true
#  wait: true
#---
#apiVersion: kustomize.toolkit.fluxcd.io/v1
#kind: Kustomization
#metadata:
#  name: infra-general-operators
#  namespace: flux-system
#spec:
#  dependsOn:
#    - name: infra-crds
#  interval: 1h
#  retryInterval: 1m
#  timeout: 5m
#  sourceRef:
#    kind: GitRepository
#    name: flux-system
#  path: ./infrastructure/base/general-operators
#  prune: true
#  wait: true