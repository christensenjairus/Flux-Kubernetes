apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-lb-stage-1
  namespace: flux-system
spec:
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/lb/stage-1
  prune: true
  patches:
    - patch: |-
        apiVersion: helm.toolkit.fluxcd.io/v2
        kind: HelmRelease
        metadata:
          name: not-used
        spec:
          speaker:
            ignoreExcludeLB: true
      target:
        kind: HelmRelease
        name: metallb
        namespace: metallb-system
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-lb-stage-2
  namespace: flux-system
spec:
  dependsOn:
    - name: infra-lb-stage-1
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/lb/stage-2
  prune: true
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-networking
  namespace: flux-system
spec:
  dependsOn:
    #- name: infra-lb-stage-2     # I forget why this was needed
    - name: infra-ingress # needed for ingresses to pass a validating webhook. Infra-ingress also depends on infra-monitoring-stage-1, which has the grafana crds
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/networking
  prune: true
  patches:
    - patch: |-
        apiVersion: helm.toolkit.fluxcd.io/v2
        kind: HelmRelease
        metadata:
          name: not-used
        spec:
          values:
            operator: 
              replicas: 1
            clustermesh:
              apiserver:
                replicas: 1
      target:
        kind: HelmRelease
        name: cilium
        namespace: kube-system
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-monitoring-stage-1
  namespace: flux-system
spec:
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/monitoring/stage-1
  prune: true
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-monitoring-stage-2
  namespace: flux-system
spec:
  dependsOn:
    - name: infra-ingress  # needed for ingress validating webhook, also ingress waits for infra-storage which is also needed for a pvc
    - name: infra-monitoring-stage-1
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/monitoring/stage-2
  prune: true
  patches:
    - patch: |-
        apiVersion: helm.toolkit.fluxcd.io/v2
        kind: HelmRelease
        metadata:
          name: not-used
        spec:
          values:
            replicas: 1
      target:
        kind: HelmRelease
        name: metrics-server
        namespace: kube-system
    # set victoria metrics resource requirements to 10% of their defaults
    - patch: |-
        apiVersion: helm.toolkit.fluxcd.io/v2
        kind: HelmRelease
        metadata:
          name: not-used
        spec:
          values:
            vmsingle:
              spec:
                resources:
                  requests:
                    memory: 50Mi
                    cpu: 15m
            vmalert:
              spec:
                resources:
                  requests:
                    memory: 20Mi
                    cpu: 5m
            vmagent:
              spec:
                resources:
                  requests:
                    memory: 20Mi
                    cpu: 10m
      target:
        kind: HelmRelease
        name: victoria-metrics-k8s-stack
        namespace: monitoring
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-certs-stage-1
  namespace: flux-system
spec:
  dependsOn:
    - name: infra-ingress # Needed for validating webhook
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/certs/stage-1
  prune: true
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-certs-stage-2
  namespace: flux-system
spec:
  dependsOn:
    - name: infra-certs-stage-1
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/certs/stage-2
  prune: false # don't delete my storage
  patches:
    - patch: | # use staging letsencrypt server
        - op: replace
          path: /spec/acme/server
          value: https://acme-staging-v02.api.letsencrypt.org/directory
      target:
        kind: ClusterIssuer
        name: letsencrypt
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-ingress
  namespace: flux-system
spec:
  dependsOn:
    #- name: infra-lb  # I forget why this was needed
    - name: infra-storage-stage-2 # needed for cache pvc
    - name: infra-monitoring-stage-1 # needed for grafana crds
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/ingress/overlays
  prune: false # don't delete my storage
  patches:
    # don't autoscale and remove resource requirements
    - patch: |-
        apiVersion: helm.toolkit.fluxcd.io/v2
        kind: HelmRelease
        metadata:
          name: not-used
        spec:
          values:
            controller:
              replicaCount: 1
              autoscaling:
                enabled: false
              resources:
                requests: {}
            defaultBackend:
              replicaCount: 1
      target:
        kind: HelmRelease
        name: ingress-nginx
        namespace: ingress-nginx.*
    # reduce the severity of NGINXTooMany400s alert
    - patch: |
        - op: replace
          path: /spec/groups/0/rules/0/labels/severity
          value: "none"
      target:
        kind: PrometheusRule
        name: prometheus-ingress-rules
        namespace: ingress-nginx.*
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-policies-stage-1
  namespace: flux-system
spec:
  interval: 1h
  retryInterval: 1m
  timeout: 5m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/policies/stage-1
  prune: true
  wait: true
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-policies-stage-2
  namespace: flux-system
spec:
  dependsOn:
    - name: infra-policies-stage-1
  interval: 1h
  retryInterval: 1m
  timeout: 5m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/policies/stage-2/overlays/harbor-registry-all-pods
  prune: true
  wait: true
#---
#apiVersion: kustomize.toolkit.fluxcd.io/v1
#kind: Kustomization
#metadata:
#  name: infra-scaling
#  namespace: flux-system
#spec:
#  interval: 1h
#  retryInterval: 1m
#  timeout: 5m
#  sourceRef:
#    kind: GitRepository
#    name: flux-system
#  path: ./infrastructure/base/scaling
#  prune: true
#  wait: true
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-storage-stage-1
  namespace: flux-system
spec:
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/storage/stage-1
  prune: true
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-storage-stage-2
  namespace: flux-system
spec:
  dependsOn:
    - name: infra-storage-stage-1
  interval: 1h
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./infrastructure/base/storage/stage-2
  prune: true
---
#apiVersion: kustomize.toolkit.fluxcd.io/v1
#kind: Kustomization
#metadata:
#  name: infra-backups
#  namespace: flux-system
#spec:
#  interval: 1h
#  retryInterval: 1m
#  timeout: 5m
#  sourceRef:
#    kind: GitRepository
#    name: flux-system
#  path: ./infrastructure/base/backups
#  prune: true
#  wait: true
#---
#apiVersion: kustomize.toolkit.fluxcd.io/v1
#kind: Kustomization
#metadata:
#  name: infra-general-operators
#  namespace: flux-system
#spec:
#  interval: 1h
#  retryInterval: 1m
#  timeout: 5m
#  sourceRef:
#    kind: GitRepository
#    name: flux-system
#  path: ./infrastructure/base/general-operators
#  prune: true
#  wait: true